Machine gateway-mensr  : Configuration Automatique Gateway DNSMASQ 1 (14:36:15)
Machine gateway-mensr  : * stop old services
 systemctl is-active systemd-resolved.service ?  pas de systemd-resolved sur les gateway car c'est DNSMASQ qui fait le job
active
 systemd-resolved.service désactivation ? 
Removed /etc/systemd/system/dbus-org.freedesktop.resolve1.service.
Removed /etc/systemd/system/multi-user.target.wants/systemd-resolved.service.
Machine gateway-mensr  : * CURRENT IP = 192.168.230.184 et VM_ETH0_IP=192.168.230.108
Machine gateway-mensr  : * Affiche Connectivité avant 
    inet 127.0.0.1/8 scope host lo
    inet 192.168.230.184/24 metric 100 brd 192.168.230.255 scope global dynamic ens4
    inet6 fe80::c0ff:fea8:e6dc/64 scope link 
    inet 192.168.0.1/24 brd 192.168.0.255 scope global ens5
    inet6 fe80::c0ff:fea8:64/64 scope link 
    inet 192.168.227.1/24 brd 192.168.227.255 scope global ens6
    inet6 fe80::c0ff:fea8:e364/64 scope link 
    inet 192.168.253.1/24 brd 192.168.253.255 scope global ens7
    inet6 fe80::c0ff:fea8:fd64/64 scope link 
    inet 172.17.0.1/16 brd 172.17.255.255 scope global docker0
* detach DHCP
Machine gateway-mensr  : * Affiche Connectivité après 
    inet 127.0.0.1/8 scope host lo
    inet 192.168.230.184/24 metric 100 brd 192.168.230.255 scope global dynamic ens4
    inet6 fe80::c0ff:fea8:e6dc/64 scope link 
    inet 192.168.0.1/24 brd 192.168.0.255 scope global ens5
    inet6 fe80::c0ff:fea8:64/64 scope link 
    inet 192.168.227.1/24 brd 192.168.227.255 scope global ens6
    inet6 fe80::c0ff:fea8:e364/64 scope link 
    inet 192.168.253.1/24 brd 192.168.253.255 scope global ens7
    inet6 fe80::c0ff:fea8:fd64/64 scope link 
    inet 172.17.0.1/16 brd 172.17.255.255 scope global docker0
Machine gateway-mensr  : * daemon reload  !
Machine gateway-mensr  : * redémarrage network !
Machine gateway-mensr  : * CURRENT IP = 192.168.230.108
Machine gateway-mensr  : Gateway pour spaillet en cours de démarrage sur 'one'
inactive
Machine gateway-mensr  : ***********************************************************
Machine gateway-mensr  : * IP V4
Machine gateway-mensr  : ***********************************************************
Machine gateway-mensr  : * Workaround docker messing up with our firewall
Machine gateway-mensr  : * Active NAT
Machine gateway-mensr  : * Active DNS par routage des trames sur l'eth1 !
Machine gateway-mensr  : * Workaround BUG 'bad udp checksum' du client dhcp sur Debian 8* Voir https://bugs.debian.org/cgi-bin/bugreport.cgi?bug=717217
iptables -A POSTROUTING -t mangle -o ens5 -p udp --dport bootpc -j CHECKSUM --checksum-fill
Machine gateway-mensr  : * Regle Iptables Filter
-P INPUT ACCEPT
-P FORWARD DROP
-P OUTPUT ACCEPT
-N DOCKER
-N DOCKER-ISOLATION-STAGE-1
-N DOCKER-ISOLATION-STAGE-2
-N DOCKER-USER
-A FORWARD -j DOCKER-USER
-A FORWARD -j DOCKER-ISOLATION-STAGE-1
-A FORWARD -o docker0 -m conntrack --ctstate RELATED,ESTABLISHED -j ACCEPT
-A FORWARD -o docker0 -j DOCKER
-A FORWARD -i docker0 ! -o docker0 -j ACCEPT
-A FORWARD -i docker0 -o docker0 -j ACCEPT
-A FORWARD -i ens4 ! -o ens4 -j ACCEPT
-A FORWARD ! -i ens4 -o ens4 -j ACCEPT
-A FORWARD -i roadwarrior -j ACCEPT
-A FORWARD -o roadwarrior -j ACCEPT
-A DOCKER-ISOLATION-STAGE-1 -i docker0 ! -o docker0 -j DOCKER-ISOLATION-STAGE-2
-A DOCKER-ISOLATION-STAGE-1 -j RETURN
-A DOCKER-ISOLATION-STAGE-2 -o docker0 -j DROP
-A DOCKER-ISOLATION-STAGE-2 -j RETURN
-A DOCKER-USER -j RETURN
Machine gateway-mensr  : * Regle Iptables NAT
-P PREROUTING ACCEPT
-P INPUT ACCEPT
-P OUTPUT ACCEPT
-P POSTROUTING ACCEPT
-N DOCKER
-A PREROUTING -i ens4 -p udp -m udp --dport 53 -j DNAT --to-destination 192.168.227.1
-A PREROUTING -i ens4 -p udp -m udp --dport 53 -j DNAT --to-destination 192.168.0.1
-A PREROUTING -m addrtype --dst-type LOCAL -j DOCKER
-A OUTPUT ! -d 127.0.0.0/8 -m addrtype --dst-type LOCAL -j DOCKER
-A POSTROUTING -s 172.17.0.0/16 ! -o docker0 -j MASQUERADE
-A POSTROUTING -d 192.168.230.254/32 -o ens4 -j SNAT --to-source 192.168.230.108
-A POSTROUTING -d 192.168.230.125/32 -o ens4 -j SNAT --to-source 192.168.230.108
-A POSTROUTING ! -d 192.168.230.0/24 -o ens4 -j SNAT --to-source 192.168.230.108
-A DOCKER -i docker0 -j RETURN
Machine gateway-mensr  : * Regle Iptables MANGLE
-P PREROUTING ACCEPT
-P INPUT ACCEPT
-P FORWARD ACCEPT
-P OUTPUT ACCEPT
-P POSTROUTING ACCEPT
-A POSTROUTING -o ens5 -p udp -m udp --dport 68 -j CHECKSUM --checksum-fill
Machine gateway-mensr  : * Regle Iptables RAW
-P PREROUTING ACCEPT
-P OUTPUT ACCEPT
Machine gateway-mensr  : * Activation Routeur PERSISTANTE
Machine gateway-mensr  : * Vérification Routeur (net.ipv4.ip_forward)
net.ipv4.ip_forward = 1
Machine gateway-mensr  : * Déactivation TCP timestamps CVE (net.ipv4.tcp_timestamps)
net.ipv4.tcp_timestamps = 0
Machine gateway-mensr  : ***********************************************************
Machine gateway-mensr  : * IP V6
Machine gateway-mensr  : ***********************************************************
Machine gateway-mensr  : * Regle Ip6tables Filter
-P INPUT ACCEPT
-P FORWARD ACCEPT
-P OUTPUT ACCEPT
Machine gateway-mensr  : * Regle Ip6tables NAT
-P PREROUTING ACCEPT
-P INPUT ACCEPT
-P OUTPUT ACCEPT
-P POSTROUTING ACCEPT
Machine gateway-mensr  : * Regle Ip6tables MANGLE
-P PREROUTING ACCEPT
-P INPUT ACCEPT
-P FORWARD ACCEPT
-P OUTPUT ACCEPT
-P POSTROUTING ACCEPT
Machine gateway-mensr  : * Regle Ip6tables RAW
-P PREROUTING ACCEPT
-P OUTPUT ACCEPT
Machine gateway-mensr  : * Affiche configuration 'sysctl'
kernel.kptr_restrict = 1                 #/etc/sysctl.d/10-kernel-hardening.conf
kernel.printk = 4 4 1 7                  #/etc/sysctl.d/10-console-messages.conf
kernel.sysrq = 176                       #/etc/sysctl.d/10-magic-sysrq.conf
kernel.yama.ptrace_scope = 1             #/etc/sysctl.d/10-ptrace.conf
net.ipv4.conf.all.rp_filter=2            #/etc/sysctl.d/10-network-security.conf
net.ipv4.conf.default.rp_filter=2        #/etc/sysctl.d/10-network-security.conf
net.ipv4.ip_forward=1                    #/etc/sysctl.d/routeur.conf
net.ipv6.conf.all.disable_ipv6=1         #/etc/sysctl.d/60-disable-ipv6.conf
net.ipv6.conf.all.use_tempaddr = 2       #/etc/sysctl.d/10-ipv6-privacy.conf
net.ipv6.conf.default.disable_ipv6=1     #/etc/sysctl.d/60-disable-ipv6.conf
net.ipv6.conf.default.use_tempaddr = 2   #/etc/sysctl.d/10-ipv6-privacy.conf
net.ipv6.conf.lo.disable_ipv6=1          #/etc/sysctl.d/60-disable-ipv6.conf
vm.mmap_min_addr = 65536                 #/etc/sysctl.d/10-zeropage.conf
               total        used        free      shared  buff/cache   available
Mem:             956         207         373           1         375         607
Swap:           3924           0        3924
* ip route add 172.31.20.0/24 via 192.168.0.39 a ajouter
* ip route add 172.31.21.0/24 via 192.168.0.39 a ajouter
Machine gateway-mensr  : * Affiche Connectivité
    inet 127.0.0.1/8 scope host lo
    inet 192.168.230.108/24 brd 192.168.230.255 scope global ens4
    inet6 fe80::c0ff:fea8:e6dc/64 scope link 
    inet 192.168.0.1/24 brd 192.168.0.255 scope global ens5
    inet6 fe80::c0ff:fea8:64/64 scope link 
    inet 192.168.227.1/24 brd 192.168.227.255 scope global ens6
    inet6 fe80::c0ff:fea8:e364/64 scope link 
    inet 192.168.253.1/24 brd 192.168.253.255 scope global ens7
    inet6 fe80::c0ff:fea8:fd64/64 scope link 
    inet 172.17.0.1/16 brd 172.17.255.255 scope global docker0
Machine gateway-mensr  : * Generate keys root/gateway108
Machine gateway-mensr  : * restauration SSHD keys from /mnt/eole-ci-tests/security/gateway_keys/root@gateway108
Machine gateway-mensr  : * restauration SSHD keys from /mnt/eole-ci-tests/security/gateway_keys/root@gateway108_ed25519
Machine gateway-mensr  : * Check /root acl
drwx------
root
root
Machine gateway-mensr  : * right /root OK
Machine gateway-mensr  : * Configure SSHD
Machine gateway-mensr  : * service ssh restart
Machine gateway-mensr  : * Configure SSH client
liste *.conf différentes!
Machine gateway-mensr  : * Vide les exceptions crée par les tests
cp: cannot stat '/tmp/dnsmasq-hostsdir/*.conf': No such file or directory
Machine gateway-mensr  : * nettoye /etc/dnsmasq.d/*.conf
Machine gateway-mensr  : * copy /tmp/dnsmasq.d/*.conf -> /etc/dnsmasq.d/*.conf
dnsmasq.conf différent! 
'/tmp/dnsmasq.conf' -> '/etc/dnsmasq.conf'
dnsmasq: syntax check OK.
* efface logs gateway
192.168.230.109 dev ens4 lladdr d4:ae:52:ce:2f:16 ref 1 used 0/0/0 probes 4 REACHABLE
192.168.0.104 dev ens5 lladdr 02:00:c0:a8:00:68 used 32/32/0 probes 1 STALE
192.168.230.254 dev ens4 lladdr d4:ae:52:ce:2f:16 used 0/60/0 probes 0 STALE
fe80::2204:fff:fea7:6f4c dev ens4 lladdr 20:04:0f:a7:6f:4c router ref 1 used 29/29/29 probes 1 REACHABLE
fe80::2204:fff:fea7:674c dev ens4 lladdr 20:04:0f:a7:67:4c router ref 1 used 29/29/29 probes 1 REACHABLE

*** Round 1, deleting 5 entries ***
*** Flush is complete after 1 round ***
* Verification 'gateway.ac-test.fr'        : 192.168.0.1
* Vérification du Forward vers Hestia      : 192.168.232.2
PING hestia.eole.lan (192.168.232.2) 56(84) bytes of data.

--- hestia.eole.lan ping statistics ---
1 packets transmitted, 0 received, 100% packet loss, time 0ms

Machine gateway-mensr  : * Inject resolv.conf
Machine gateway-mensr  : * Démarrage DNSMASQ
active
● dnsmasq.service - dnsmasq - A lightweight DHCP and caching DNS server
     Loaded: loaded (/lib/systemd/system/dnsmasq.service; enabled; vendor preset: enabled)
     Active: active (running) since Thu 2024-04-04 14:36:18 CEST; 12s ago
    Process: 1874 ExecStartPre=/etc/init.d/dnsmasq checkconfig (code=exited, status=0/SUCCESS)
    Process: 1882 ExecStart=/etc/init.d/dnsmasq systemd-exec (code=exited, status=0/SUCCESS)
    Process: 1892 ExecStartPost=/etc/init.d/dnsmasq systemd-start-resolvconf (code=exited, status=0/SUCCESS)
   Main PID: 1890 (dnsmasq)
      Tasks: 2 (limit: 1010)
     Memory: 984.0K
        CPU: 49ms
     CGroup: /system.slice/dnsmasq.service
             ├─1890 /usr/sbin/dnsmasq -x /run/dnsmasq/dnsmasq.pid -u dnsmasq -7 /etc/dnsmasq.d,.dpkg-dist,.dpkg-old,.dpkg-new --local-service --trust-anchor=.,20326,8,2,e06d44b80b8f1d39a95c0b0d7c65d08458e880409bbc683457104237c7f8ec8d
             └─1891 /usr/sbin/dnsmasq -x /run/dnsmasq/dnsmasq.pid -u dnsmasq -7 /etc/dnsmasq.d,.dpkg-dist,.dpkg-old,.dpkg-new --local-service --trust-anchor=.,20326,8,2,e06d44b80b8f1d39a95c0b0d7c65d08458e880409bbc683457104237c7f8ec8d

avril 04 14:36:20 gateway108 dnsmasq[1890]: reply . is <NS>
avril 04 14:36:20 gateway108 dnsmasq[1890]: reply . is <NS>
avril 04 14:36:20 gateway108 dnsmasq[1890]: reply . is <NS>
avril 04 14:36:20 gateway108 dnsmasq[1890]: reply . is <NS>
avril 04 14:36:20 gateway108 dnsmasq[1890]: reply . is <NS>
avril 04 14:36:20 gateway108 dnsmasq[1890]: query[A] gateway.ac-test.fr from 192.168.0.1
avril 04 14:36:20 gateway108 dnsmasq[1890]: /etc/hosts gateway.ac-test.fr is 192.168.0.1
avril 04 14:36:20 gateway108 dnsmasq[1890]: query[A] hestia.eole.lan from 192.168.0.1
avril 04 14:36:20 gateway108 dnsmasq[1890]: forwarded hestia.eole.lan to 192.168.232.2
avril 04 14:36:20 gateway108 dnsmasq[1890]: reply hestia.eole.lan is 192.168.232.2
Machine gateway-mensr  : AGENT_JENKINS non définie dans le context!
Machine gateway-mensr  : * status systemd-timesyncd
               Local time: jeu. 2024-04-04 14:36:31 CEST
           Universal time: jeu. 2024-04-04 12:36:31 UTC
                 RTC time: jeu. 2024-04-04 12:36:31
                Time zone: Europe/Paris (CEST, +0200)
System clock synchronized: yes
              NTP service: active
          RTC in local TZ: no
Machine gateway-mensr  : * Configuration chrony
Machine gateway-mensr  : * Démarrage Chronyd
alias
● chrony.service - chrony, an NTP client/server
     Loaded: loaded (/lib/systemd/system/chrony.service; enabled; vendor preset: enabled)
     Active: active (running) since Thu 2024-04-04 14:36:31 CEST; 8ms ago
       Docs: man:chronyd(8)
             man:chronyc(1)
             man:chrony.conf(5)
    Process: 1924 ExecStart=/usr/lib/systemd/scripts/chronyd-starter.sh $DAEMON_OPTS (code=exited, status=0/SUCCESS)
   Main PID: 1933 (chronyd)
      Tasks: 2 (limit: 1010)
     Memory: 1.7M
        CPU: 47ms
     CGroup: /system.slice/chrony.service
             ├─1933 /usr/sbin/chronyd -F 1
             └─1934 /usr/sbin/chronyd -F 1

avril 04 14:36:31 gateway108 systemd[1]: Starting chrony, an NTP client/server...
avril 04 14:36:31 gateway108 chronyd[1933]: chronyd version 4.2 starting (+CMDMON +NTP +REFCLOCK +RTC +PRIVDROP +SCFILTER +SIGND +ASYNCDNS +NTS +SECHASH +IPV6 -DEBUG)
avril 04 14:36:31 gateway108 chronyd[1933]: Frequency 0.000 +/- 1000000.000 ppm read from /var/lib/chrony/chrony.drift
avril 04 14:36:31 gateway108 chronyd[1933]: Loaded seccomp filter (level 1)
avril 04 14:36:31 gateway108 systemd[1]: Started chrony, an NTP client/server.
Machine gateway-mensr  : * Démarrage Chrony
enabled
● chrony.service - chrony, an NTP client/server
     Loaded: loaded (/lib/systemd/system/chrony.service; enabled; vendor preset: enabled)
     Active: active (running) since Thu 2024-04-04 14:36:31 CEST; 29ms ago
       Docs: man:chronyd(8)
             man:chronyc(1)
             man:chrony.conf(5)
    Process: 1924 ExecStart=/usr/lib/systemd/scripts/chronyd-starter.sh $DAEMON_OPTS (code=exited, status=0/SUCCESS)
   Main PID: 1933 (chronyd)
      Tasks: 2 (limit: 1010)
     Memory: 1.2M
        CPU: 47ms
     CGroup: /system.slice/chrony.service
             ├─1933 /usr/sbin/chronyd -F 1
             └─1934 /usr/sbin/chronyd -F 1

avril 04 14:36:31 gateway108 systemd[1]: Starting chrony, an NTP client/server...
avril 04 14:36:31 gateway108 chronyd[1933]: chronyd version 4.2 starting (+CMDMON +NTP +REFCLOCK +RTC +PRIVDROP +SCFILTER +SIGND +ASYNCDNS +NTS +SECHASH +IPV6 -DEBUG)
avril 04 14:36:31 gateway108 chronyd[1933]: Frequency 0.000 +/- 1000000.000 ppm read from /var/lib/chrony/chrony.drift
avril 04 14:36:31 gateway108 chronyd[1933]: Loaded seccomp filter (level 1)
avril 04 14:36:31 gateway108 systemd[1]: Started chrony, an NTP client/server.
Machine gateway-mensr  : * Test 'chronyc tracking'
Reference ID    : 7F7F0101 ()
Stratum         : 10
Ref time (UTC)  : Thu Apr 04 12:36:29 2024
System time     : 0.000000000 seconds fast of NTP time
Last offset     : +0.000000000 seconds
RMS offset      : 0.000000000 seconds
Frequency       : 0.000 ppm slow
Residual freq   : +0.000 ppm
Skew            : 0.000 ppm
Root delay      : 0.000000000 seconds
Root dispersion : 0.000000000 seconds
Update interval : 0.0 seconds
Leap status     : Normal
Machine gateway-mensr  : * Test 'chronyc sourcestats'
Name/IP Address            NP  NR  Span  Frequency  Freq Skew  Offset  Std Dev
==============================================================================
192.168.232.2               0   0     0     +0.000   2000.000     +0ns  4000ms
Machine gateway-mensr  : * Add roadwarrior GRE tunnel
Machine gateway-mensr  : * Activation Ecoute tcp DOCKER ?
ExecStart=/usr/bin/dockerd -H fd:// -H tcp://0.0.0.0:2375 --dns 192.168.0.1 --dns 192.168.232.2
root        1054  1.6  7.7 1540360 76132 ?       Ssl  14:35   0:00 /usr/bin/dockerd -H fd:// -H tcp://0.0.0.0:2375 --dns 192.168.0.1 --dns 192.168.232.2
root        1970  0.0  0.2   6756  2488 ?        S    14:36   0:00 grep dockerd
Machine gateway-mensr  : * création /etc/email-addresses
Machine gateway-mensr  : * création /etc/aliases
Machine gateway-mensr  : * création /etc/exim4/update-exim4.conf.conf
Machine gateway-mensr  : * réécriture des adresses mails (/etc/exim4/conf.d/rewrite/40_exim4-config_rewrite_ac-test)
Machine gateway-mensr  : * cat /var/log/exim4/paniclog avant reset !
cat: /var/log/exim4/paniclog: No such file or directory
/bin/rm: cannot remove '/var/log/exim4/paniclog': No such file or directory
Machine gateway-mensr  : * restart Exim4
Job for exim4.service failed because the control process exited with error code.
See "systemctl status exim4.service" and "journalctl -xeu exim4.service" for details.
/usr/bin/mail
Machine gateway-mensr  : * test mail to USER
Machine gateway-mensr  : * netstat 
tcp        0      0 127.0.0.1:25            0.0.0.0:*               LISTEN      1325/exim4          
Machine gateway-mensr  : * ecoute :25 ok
Machine gateway-mensr  : AGENT_JENKINS non définit dans le context!
Machine gateway-mensr  : AGENT_GITLAB non définit dans le context!
Machine gateway-mensr  : Démarrée sur 'one' pour 'spaillet'
Machine gateway-mensr  : pas de function startup utilisateur 'ciOnStartUp' 
Machine gateway-mensr  : * Fin ok
Machine gateway-mensr  : Démarrée en 192.168.230.108
/usr/bin/updatedb
Machine gateway-mensr  : * désactivation updatedb/locate sur /mnt/eole-ci-test présente !
