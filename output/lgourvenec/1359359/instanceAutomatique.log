Machine gateway-mensr  : Configuration Automatique Gateway DNSMASQ 1 (14:31:36)
Machine gateway-mensr  : * stop old services
/usr/sbin/dhclient
 systemctl is-active systemd-resolved.service ?  pas de systemd-resolved sur les gateway car c'est DNSMASQ qui fait le job
inactive
Machine gateway-mensr  : * CURRENT IP = 192.168.230.111 et VM_ETH0_IP=192.168.230.111
Machine gateway-mensr  : Gateway pour lgourvenec en cours de démarrage sur 'one'
inactive
Machine gateway-mensr  : ***********************************************************
Machine gateway-mensr  : * IP V4
Machine gateway-mensr  : ***********************************************************
Machine gateway-mensr  : * Workaround docker messing up with our firewall
Machine gateway-mensr  : * Active NAT
Machine gateway-mensr  : * Active DNS par routage des trames sur l'eth1 !
Machine gateway-mensr  : * Workaround BUG 'bad udp checksum' du client dhcp sur Debian 8* Voir https://bugs.debian.org/cgi-bin/bugreport.cgi?bug=717217
iptables -A POSTROUTING -t mangle -o enp3s0 -p udp --dport bootpc -j CHECKSUM --checksum-fill
Machine gateway-mensr  : * Regle Iptables Filter
-P INPUT ACCEPT
-P FORWARD ACCEPT
-P OUTPUT ACCEPT
-N DOCKER
-N DOCKER-ISOLATION-STAGE-1
-N DOCKER-ISOLATION-STAGE-2
-N DOCKER-USER
-A FORWARD -j DOCKER-USER
-A FORWARD -j DOCKER-ISOLATION-STAGE-1
-A FORWARD -o docker0 -m conntrack --ctstate RELATED,ESTABLISHED -j ACCEPT
-A FORWARD -o docker0 -j DOCKER
-A FORWARD -i docker0 ! -o docker0 -j ACCEPT
-A FORWARD -i docker0 -o docker0 -j ACCEPT
-A FORWARD -i enp2s0 ! -o enp2s0 -j ACCEPT
-A FORWARD ! -i enp2s0 -o enp2s0 -j ACCEPT
-A FORWARD -i roadwarrior -j ACCEPT
-A FORWARD -o roadwarrior -j ACCEPT
-A FORWARD -i enp2s0 ! -o enp2s0 -j ACCEPT
-A FORWARD ! -i enp2s0 -o enp2s0 -j ACCEPT
-A FORWARD -i roadwarrior -j ACCEPT
-A FORWARD -o roadwarrior -j ACCEPT
-A DOCKER-ISOLATION-STAGE-1 -i docker0 ! -o docker0 -j DOCKER-ISOLATION-STAGE-2
-A DOCKER-ISOLATION-STAGE-1 -j RETURN
-A DOCKER-ISOLATION-STAGE-2 -o docker0 -j DROP
-A DOCKER-ISOLATION-STAGE-2 -j RETURN
-A DOCKER-USER -j RETURN
Machine gateway-mensr  : * Regle Iptables NAT
-P PREROUTING ACCEPT
-P INPUT ACCEPT
-P OUTPUT ACCEPT
-P POSTROUTING ACCEPT
-N DOCKER
-A PREROUTING -i enp2s0 -p udp -m udp --dport 53 -j DNAT --to-destination 192.168.227.1
-A PREROUTING -i enp2s0 -p udp -m udp --dport 53 -j DNAT --to-destination 192.168.0.1
-A PREROUTING -d 192.168.230.111/32 -p tcp -m tcp --dport 9998 -j DNAT --to-destination 192.168.10.136
-A PREROUTING -d 192.168.230.111/32 -p tcp -m tcp --dport 80 -j DNAT --to-destination 192.168.10.140
-A PREROUTING -d 192.168.230.111/32 -p tcp -m tcp --dport 443 -j DNAT --to-destination 192.168.10.140
-A PREROUTING -i enp2s0 -p udp -m udp --dport 53 -j DNAT --to-destination 192.168.227.1
-A PREROUTING -i enp2s0 -p udp -m udp --dport 53 -j DNAT --to-destination 192.168.0.1
-A PREROUTING -m addrtype --dst-type LOCAL -j DOCKER
-A OUTPUT ! -d 127.0.0.0/8 -m addrtype --dst-type LOCAL -j DOCKER
-A POSTROUTING -s 172.17.0.0/16 ! -o docker0 -j MASQUERADE
-A POSTROUTING -d 192.168.230.254/32 -o enp2s0 -j SNAT --to-source 192.168.230.111
-A POSTROUTING -d 192.168.230.125/32 -o enp2s0 -j SNAT --to-source 192.168.230.111
-A POSTROUTING ! -d 192.168.230.0/24 -o enp2s0 -j SNAT --to-source 192.168.230.111
-A POSTROUTING -s 192.168.0.0/24 -j MASQUERADE
-A POSTROUTING -s 192.168.230.0/24 -j MASQUERADE
-A POSTROUTING -d 192.168.230.254/32 -o enp2s0 -j SNAT --to-source 192.168.230.111
-A POSTROUTING -d 192.168.230.125/32 -o enp2s0 -j SNAT --to-source 192.168.230.111
-A POSTROUTING ! -d 192.168.230.0/24 -o enp2s0 -j SNAT --to-source 192.168.230.111
-A DOCKER -i docker0 -j RETURN
Machine gateway-mensr  : * Regle Iptables MANGLE
-P PREROUTING ACCEPT
-P INPUT ACCEPT
-P FORWARD ACCEPT
-P OUTPUT ACCEPT
-P POSTROUTING ACCEPT
-A POSTROUTING -o enp3s0 -p udp -m udp --dport 68 -j CHECKSUM --checksum-fill
-A POSTROUTING -o enp3s0 -p udp -m udp --dport 68 -j CHECKSUM --checksum-fill
Machine gateway-mensr  : * Regle Iptables RAW
-P PREROUTING ACCEPT
-P OUTPUT ACCEPT
Machine gateway-mensr  : * Activation Routeur PERSISTANTE
Machine gateway-mensr  : * Vérification Routeur (net.ipv4.ip_forward)
net.ipv4.ip_forward = 1
Machine gateway-mensr  : * Déactivation TCP timestamps CVE (net.ipv4.tcp_timestamps)
net.ipv4.tcp_timestamps = 0
Machine gateway-mensr  : ***********************************************************
Machine gateway-mensr  : * IP V6
Machine gateway-mensr  : ***********************************************************
Machine gateway-mensr  : * Regle Ip6tables Filter
-P INPUT ACCEPT
-P FORWARD DROP
-P OUTPUT ACCEPT
-N DOCKER
-N DOCKER-ISOLATION-STAGE-1
-N DOCKER-ISOLATION-STAGE-2
-N DOCKER-USER
-A FORWARD -j DOCKER-USER
-A DOCKER-ISOLATION-STAGE-1 -i docker0 ! -o docker0 -j DOCKER-ISOLATION-STAGE-2
-A DOCKER-ISOLATION-STAGE-1 -j RETURN
-A DOCKER-ISOLATION-STAGE-2 -o docker0 -j DROP
-A DOCKER-ISOLATION-STAGE-2 -j RETURN
-A DOCKER-USER -j RETURN
Machine gateway-mensr  : * Regle Ip6tables NAT
-P PREROUTING ACCEPT
-P INPUT ACCEPT
-P OUTPUT ACCEPT
-P POSTROUTING ACCEPT
-N DOCKER
Machine gateway-mensr  : * Regle Ip6tables MANGLE
-P PREROUTING ACCEPT
-P INPUT ACCEPT
-P FORWARD ACCEPT
-P OUTPUT ACCEPT
-P POSTROUTING ACCEPT
Machine gateway-mensr  : * Regle Ip6tables RAW
-P PREROUTING ACCEPT
-P OUTPUT ACCEPT
Machine gateway-mensr  : * Affiche configuration 'sysctl'
kernel.kptr_restrict = 1                 #/etc/sysctl.d/10-kernel-hardening.conf
kernel.printk = 4 4 1 7                  #/etc/sysctl.d/10-console-messages.conf
kernel.sysrq = 176                       #/etc/sysctl.d/10-magic-sysrq.conf
kernel.yama.ptrace_scope = 1             #/etc/sysctl.d/10-ptrace.conf
-net.core.default_qdisc = fq_codel       #/etc/sysctl.d/10-bufferbloat.conf
net.ipv4.conf.all.rp_filter=2            #/etc/sysctl.d/10-network-security.conf
net.ipv4.conf.default.rp_filter=2        #/etc/sysctl.d/10-network-security.conf
net.ipv4.ip_forward=1                    #/etc/sysctl.d/routeur.conf
net.ipv6.conf.all.disable_ipv6=1         #/etc/sysctl.d/60-disable-ipv6.conf
net.ipv6.conf.all.use_tempaddr = 2       #/etc/sysctl.d/10-ipv6-privacy.conf
net.ipv6.conf.default.disable_ipv6=1     #/etc/sysctl.d/60-disable-ipv6.conf
net.ipv6.conf.default.use_tempaddr = 2   #/etc/sysctl.d/10-ipv6-privacy.conf
net.ipv6.conf.lo.disable_ipv6=1          #/etc/sysctl.d/60-disable-ipv6.conf
vm.max_map_count=1048576                 #/etc/sysctl.d/10-map-count.conf
vm.mmap_min_addr = 65536                 #/etc/sysctl.d/10-zeropage.conf
               total        used        free      shared  buff/cache   available
Mem:             955         378         430           1         289         577
Swap:           3910           0        3910
* ip route add 172.31.20.0/24 via 192.168.0.39 a ajouter
* ip route add 172.31.21.0/24 via 192.168.0.39 a ajouter
Machine gateway-mensr  : * Affiche Connectivité
    inet 127.0.0.1/8 scope host lo
    inet 192.168.230.111/24 brd 192.168.230.255 scope global enp2s0
    inet6 fe80::c0ff:fea8:e6d9/64 scope link 
    inet 192.168.0.1/24 brd 192.168.0.255 scope global enp3s0
    inet6 fe80::c0ff:fea8:64/64 scope link 
    inet 192.168.227.1/24 brd 192.168.227.255 scope global enp4s0
    inet6 fe80::c0ff:fea8:e364/64 scope link 
    inet 192.168.253.1/24 brd 192.168.253.255 scope global enp5s0
    inet6 fe80::c0ff:fea8:fd64/64 scope link 
    inet 172.17.0.1/16 brd 172.17.255.255 scope global docker0
Machine gateway-mensr  : * Generate keys root/gateway111
Machine gateway-mensr  : * cles SSHD à jour
ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQDVtA4Cj1ExqmXC9EKW9t3jyKEjbFpo6bcIAtpIAA/xAQRV1j/UEZs7AslC1GfmEOIH5KIVgnfDzbNulGNQ9w4jpZz11nMskKtxH2Z3mnPCXH8h06xrijQ/fLimupC2Sgai8S8N/Z5JfHr1e9Dx60QmKZYJG9EhM15wFsxLcYG76i6kv/FU6XbyX88oRJcWbMV5Hd+37SFtF+odX0iw3oc2FcRBdD/RMheVeYheoH+DaevnDpgHOwapoyBS7qeS5kAbezrV5yXflr0CbzYd4gjIa3ydieV90QrJ/NiGCWNrSYjEtOp9+omnIi2uCaFecgFzjXL71qVbPdPFr1E5lWxd root@gateway111
Machine gateway-mensr  : * restauration SSHD keys from /mnt/eole-ci-tests/security/gateway_keys/root@gateway111_ed25519
Machine gateway-mensr  : * Check /root acl
drwx------
root
root
Machine gateway-mensr  : * right /root OK
Machine gateway-mensr  : * Configure SSHD
Machine gateway-mensr  : * service ssh restart
Machine gateway-mensr  : * Configure SSH client
* Verification 'gateway.ac-test.fr'        : 192.168.0.1
* Vérification du Forward vers Hestia      : 192.168.232.2
PING hestia.eole.lan (192.168.232.2) 56(84) bytes of data.

--- hestia.eole.lan ping statistics ---
1 packets transmitted, 0 received, 100% packet loss, time 0ms

dnsmasq ok, pas de reload
Machine gateway-mensr  : * Inject resolv.conf
Machine gateway-mensr  : * Démarrage DNSMASQ
active
● dnsmasq.service - dnsmasq - A lightweight DHCP and caching DNS server
     Loaded: loaded (/usr/lib/systemd/system/dnsmasq.service; enabled; preset: enabled)
     Active: active (running) since Wed 2024-09-25 14:31:16 CEST; 31s ago
    Process: 866 ExecStartPre=/usr/share/dnsmasq/systemd-helper checkconfig (code=exited, status=0/SUCCESS)
    Process: 893 ExecStart=/usr/share/dnsmasq/systemd-helper exec (code=exited, status=0/SUCCESS)
    Process: 905 ExecStartPost=/usr/share/dnsmasq/systemd-helper start-resolvconf (code=exited, status=0/SUCCESS)
   Main PID: 903 (dnsmasq)
      Tasks: 2 (limit: 1061)
     Memory: 3.9M (peak: 5.4M)
        CPU: 48ms
     CGroup: /system.slice/dnsmasq.service
             ├─903 /usr/sbin/dnsmasq -x /run/dnsmasq/dnsmasq.pid -u dnsmasq -r /run/dnsmasq/resolv.conf -7 /etc/dnsmasq.d,.dpkg-dist,.dpkg-old,.dpkg-new --local-service --trust-anchor=.,20326,8,2,e06d44b80b8f1d39a95c0b0d7c65d08458e880409bbc683457104237c7f8ec8d
             └─904 /usr/sbin/dnsmasq -x /run/dnsmasq/dnsmasq.pid -u dnsmasq -r /run/dnsmasq/resolv.conf -7 /etc/dnsmasq.d,.dpkg-dist,.dpkg-old,.dpkg-new --local-service --trust-anchor=.,20326,8,2,e06d44b80b8f1d39a95c0b0d7c65d08458e880409bbc683457104237c7f8ec8d

sept. 25 14:31:37 gateway111 dnsmasq[903]: query[A] gateway.ac-test.fr from 192.168.230.111
sept. 25 14:31:37 gateway111 dnsmasq[903]: /etc/hosts gateway.ac-test.fr is 192.168.0.1
sept. 25 14:31:37 gateway111 dnsmasq[903]: query[A] hestia.eole.lan from 192.168.230.111
sept. 25 14:31:37 gateway111 dnsmasq[903]: forwarded hestia.eole.lan to 192.168.232.2
sept. 25 14:31:37 gateway111 dnsmasq[903]: reply hestia.eole.lan is 192.168.232.2
sept. 25 14:31:37 gateway111 dnsmasq[903]: query[A] hestia.eole.lan from 127.0.0.1
sept. 25 14:31:37 gateway111 dnsmasq[903]: cached hestia.eole.lan is 192.168.232.2
sept. 25 14:31:37 gateway111 dnsmasq[903]: query[AAAA] hestia.eole.lan from 127.0.0.1
sept. 25 14:31:37 gateway111 dnsmasq[903]: forwarded hestia.eole.lan to 192.168.232.2
sept. 25 14:31:37 gateway111 dnsmasq[903]: reply hestia.eole.lan is NODATA-IPv6
Machine gateway-mensr  : AGENT_JENKINS non définie dans le context!
Machine gateway-mensr  : * status systemd-timesyncd
               Local time: mer. 2024-09-25 14:31:47 CEST
           Universal time: mer. 2024-09-25 12:31:47 UTC
                 RTC time: mer. 2024-09-25 12:31:47
                Time zone: Europe/Paris (CEST, +0200)
System clock synchronized: yes
              NTP service: active
          RTC in local TZ: no
Machine gateway-mensr  : * Configuration chrony
Machine gateway-mensr  : * Démarrage Chronyd
alias
● chrony.service - chrony, an NTP client/server
     Loaded: loaded (/usr/lib/systemd/system/chrony.service; enabled; preset: enabled)
     Active: active (running) since Wed 2024-09-25 14:31:47 CEST; 9ms ago
       Docs: man:chronyd(8)
             man:chronyc(1)
             man:chrony.conf(5)
    Process: 1774 ExecStart=/usr/lib/systemd/scripts/chronyd-starter.sh $DAEMON_OPTS (code=exited, status=0/SUCCESS)
   Main PID: 1783 (chronyd)
      Tasks: 2 (limit: 1061)
     Memory: 1.3M (peak: 2.4M)
        CPU: 37ms
     CGroup: /system.slice/chrony.service
             ├─1783 /usr/sbin/chronyd -F 1
             └─1784 /usr/sbin/chronyd -F 1

sept. 25 14:31:47 gateway111 systemd[1]: Starting chrony.service - chrony, an NTP client/server...
sept. 25 14:31:47 gateway111 chronyd[1783]: chronyd version 4.5 starting (+CMDMON +NTP +REFCLOCK +RTC +PRIVDROP +SCFILTER +SIGND +ASYNCDNS +NTS +SECHASH +IPV6 -DEBUG)
sept. 25 14:31:47 gateway111 chronyd[1783]: Loaded 0 symmetric keys
sept. 25 14:31:47 gateway111 chronyd[1783]: Frequency -38.745 +/- 0.408 ppm read from /var/lib/chrony/chrony.drift
sept. 25 14:31:47 gateway111 chronyd[1783]: Loaded seccomp filter (level 1)
sept. 25 14:31:47 gateway111 systemd[1]: Started chrony.service - chrony, an NTP client/server.
Machine gateway-mensr  : * Démarrage Chrony
enabled
● chrony.service - chrony, an NTP client/server
     Loaded: loaded (/usr/lib/systemd/system/chrony.service; enabled; preset: enabled)
     Active: active (running) since Wed 2024-09-25 14:31:47 CEST; 39ms ago
       Docs: man:chronyd(8)
             man:chronyc(1)
             man:chrony.conf(5)
    Process: 1774 ExecStart=/usr/lib/systemd/scripts/chronyd-starter.sh $DAEMON_OPTS (code=exited, status=0/SUCCESS)
   Main PID: 1783 (chronyd)
      Tasks: 2 (limit: 1061)
     Memory: 1.2M (peak: 2.4M)
        CPU: 37ms
     CGroup: /system.slice/chrony.service
             ├─1783 /usr/sbin/chronyd -F 1
             └─1784 /usr/sbin/chronyd -F 1

sept. 25 14:31:47 gateway111 systemd[1]: Starting chrony.service - chrony, an NTP client/server...
sept. 25 14:31:47 gateway111 chronyd[1783]: chronyd version 4.5 starting (+CMDMON +NTP +REFCLOCK +RTC +PRIVDROP +SCFILTER +SIGND +ASYNCDNS +NTS +SECHASH +IPV6 -DEBUG)
sept. 25 14:31:47 gateway111 chronyd[1783]: Loaded 0 symmetric keys
sept. 25 14:31:47 gateway111 chronyd[1783]: Frequency -38.745 +/- 0.408 ppm read from /var/lib/chrony/chrony.drift
sept. 25 14:31:47 gateway111 chronyd[1783]: Loaded seccomp filter (level 1)
sept. 25 14:31:47 gateway111 systemd[1]: Started chrony.service - chrony, an NTP client/server.
Machine gateway-mensr  : * Test 'chronyc tracking'
Reference ID    : 7F7F0101 ()
Stratum         : 10
Ref time (UTC)  : Wed Sep 25 12:31:45 2024
System time     : 0.000000000 seconds slow of NTP time
Last offset     : +0.000000000 seconds
RMS offset      : 0.000000000 seconds
Frequency       : 38.745 ppm slow
Residual freq   : +0.000 ppm
Skew            : 0.000 ppm
Root delay      : 0.000000000 seconds
Root dispersion : 0.000000000 seconds
Update interval : 0.0 seconds
Leap status     : Normal
Machine gateway-mensr  : * Test 'chronyc sourcestats'
Name/IP Address            NP  NR  Span  Frequency  Freq Skew  Offset  Std Dev
==============================================================================
192.168.232.2               0   0     0     +0.000   2000.000     +0ns  4000ms
Machine gateway-mensr  : * Add roadwarrior GRE tunnel
Machine gateway-mensr  : * Activation Ecoute tcp DOCKER ?
ExecStart=/usr/bin/dockerd -H fd:// -H tcp://0.0.0.0:2375 --dns 192.168.0.1 --dns 192.168.232.2
root         926  0.8  7.9 2061880 77440 ?       Ssl  14:31   0:00 /usr/bin/dockerd -H fd:// -H tcp://0.0.0.0:2375 --dns 192.168.0.1 --dns 192.168.232.2
root        1821  0.0  0.2   6688  2560 ?        S    14:31   0:00 grep dockerd
Machine gateway-mensr  : * création /etc/email-addresses
Machine gateway-mensr  : * création /etc/aliases
Machine gateway-mensr  : * création /etc/exim4/update-exim4.conf.conf
Machine gateway-mensr  : * réécriture des adresses mails (/etc/exim4/conf.d/rewrite/40_exim4-config_rewrite_ac-test)
Machine gateway-mensr  : * cat /var/log/exim4/paniclog avant reset !
/bin/rm: cannot remove '/var/log/exim4/paniclog': Operation not permitted
touch: cannot touch '/var/log/exim4/paniclog': Operation not permitted
Machine gateway-mensr  : * restart Exim4
/usr/bin/mail
Machine gateway-mensr  : * test mail to USER
Machine gateway-mensr  : * netstat 
tcp        0      0 192.168.227.1:25        0.0.0.0:*               LISTEN      2477/exim4          
tcp        0      0 127.0.0.1:25            0.0.0.0:*               LISTEN      2477/exim4          
tcp        0      0 192.168.0.1:25          0.0.0.0:*               LISTEN      2477/exim4          
tcp        0      0 192.168.230.111:25      0.0.0.0:*               LISTEN      2477/exim4          
Machine gateway-mensr  : * ecoute :25 ok
Machine gateway-mensr  : AGENT_JENKINS non définit dans le context!
Machine gateway-mensr  : AGENT_GITLAB non définit dans le context!
Machine gateway-mensr  : Démarrée sur 'one' pour 'lgourvenec'
Machine gateway-mensr  : pas de function startup utilisateur 'ciOnStartUp' 
Machine gateway-mensr  : * Fin ok
Machine gateway-mensr  : Démarrée en 192.168.230.111
