<?xml version="1.0" ?>
<lsc xmlns="http://lsc-project.org/XSD/lsc-core-2.2.xsd" revision="0">
  <connections>
    <ldapConnection>
      <name>openldap-src-conn</name>
      <url>ldap://scribe.ac-test.fr:389/o=gouv,c=fr</url>
      <username>cn=admin,o=gouv,c=fr</username>
      <password>Aisheinge8xi</password>
      <authentication>SIMPLE</authentication>
      <referral>IGNORE</referral>
      <derefAliases>NEVER</derefAliases>
      <version>VERSION_3</version>
      <pageSize>-1</pageSize>
      <factory>com.sun.jndi.ldap.LdapCtxFactory</factory>
      <tlsActivated>false</tlsActivated>
    </ldapConnection>

    <ldapConnection>
      <name>ldap-dst-conn</name>
      <url>ldaps://192.168.0.5:636/DC=domseth,DC=ac-test,DC=fr</url>
      <username>CN=Administrator,CN=Users,DC=domseth,DC=ac-test,DC=fr</username>
      <password>Eole12345!</password>
      <authentication>SIMPLE</authentication>
      <referral>IGNORE</referral>
      <derefAliases>NEVER</derefAliases>
      <version>VERSION_3</version>
      <pageSize>1</pageSize>
      <factory>com.sun.jndi.ldap.LdapCtxFactory</factory>
      <tlsActivated>false</tlsActivated>
    </ldapConnection>
  </connections>

  <tasks>
    <task>
      <name>users</name>
      <bean>org.lsc.beans.SimpleBean</bean>

      <asyncLdapSourceService>
        <name>openldap-src-service-users</name>
        <connection reference="openldap-src-conn" />
        <baseDn>ou=education,o=gouv,c=fr</baseDn>
        <pivotAttributes>
          <string>uid</string>
        </pivotAttributes>
        <fetchedAttributes>
          <string>cn</string>
          <string>sn</string>
          <string>uid</string>
          <string>mail</string>
          <string>givenName</string>
          <string>displayName</string>
          <string>uidNumber</string>
          <string>gidNumber</string>
          <string>personalTitle</string>
          <string>homeDirectory</string>
          <string>sambaHomePath</string>
          <string>sambaHomeDrive</string>
          <!--<string>sambaLogonTime</string>-->
          <!--<string>sambaLogoffTime</string>-->
          <!--<string>sambaProfilePath</string>-->
          <string>ENTPersonLogin</string>
          <string>ENTPersonJointure</string>
          <string>ENTPersonProfils</string>
          <string>ENTPersonNomPatro</string>
          <string>ENTPersonSexe</string>
          <string>ENTPersonDateNaissance</string>
          <string>codecivilite</string>
          <string>dateNaissance</string>
          <string>intid</string>
          <string>typeadmin</string>
          <string>Divcod</string>
          <string>Ine</string>
        </fetchedAttributes>
        <getAllFilter>(&amp;(objectClass=inetOrgPerson)(objectClass=posixAccount))</getAllFilter>
        <getOneFilter>(&amp;(objectClass=inetOrgPerson)(objectClass=posixAccount)(uid={uid}))</getOneFilter>
        <cleanFilter>(&amp;(objectClass=inetOrgPerson)(objectClass=posixAccount)(uid={sAMAccountName}))</cleanFilter>
        <serverType>OpenLDAP</serverType>
      </asyncLdapSourceService>
      <ldapDestinationService>
        <name>ldap-dst-service-users</name>
        <connection reference="ldap-dst-conn" />
        <baseDn>CN=Users,DC=domseth,DC=ac-test,DC=fr</baseDn>
        <pivotAttributes>
          <string>sAMAccountName</string>
        </pivotAttributes>
        <fetchedAttributes>
          <string>sAMAccountName</string>
          <string>cn</string>
          <string>sn</string>
          <string>objectClass</string>
          <string>mail</string>
          <string>givenName</string>
          <string>displayName</string>
          <string>personalTitle</string>
          <string>homeDirectory</string>
          <string>homeDrive</string>
          <!--<string>lastLogon</string>-->
          <!--<string>lastLogoff</string>-->
          <!--<string>profilePath</string>-->
          <string>ou</string>
          <string>userAccountControl</string>
        </fetchedAttributes>
        <getAllFilter>(&amp;(objectClass=user)(!(objectClass=computer))(!(isCriticalSystemObject=TRUE)))</getAllFilter>
        <getOneFilter>(&amp;(objectClass=user)(!(objectClass=computer))(!(isCriticalSystemObject=TRUE))(sAMAccountName={uid}))</getOneFilter>
      </ldapDestinationService>
      <propertiesBasedSyncOptions>
        <mainIdentifier>"CN=" + srcBean.getDatasetFirstValueById("uid") + ",CN=Users,DC=domseth,DC=ac-test,DC=fr"</mainIdentifier>
        <defaultDelimiter>;</defaultDelimiter>
        <defaultPolicy>FORCE</defaultPolicy>
        <conditions>
                <create>true</create>
                <update>true</update>
                <delete>true</delete>
                <changeId>false</changeId>
        </conditions>
        <dataset>
          <name>objectClass</name>
          <policy>KEEP</policy>
          <defaultValues></defaultValues>
          <forceValues></forceValues>
          <createValues>
            <string>"top"</string>
            <string>"person"</string>
            <string>"organizationalPerson"</string>
            <string>"user"</string>
          </createValues>
        </dataset>
        <dataset>
          <name>cn</name>
          <policy>FORCE</policy>
          <defaultValues></defaultValues>
          <forceValues>
            <string>srcBean.getDatasetFirstValueById("uid")</string>
          </forceValues>
          <createValues></createValues>
        </dataset>
        <dataset>
          <name>sAMAccountName</name>
          <policy>FORCE</policy>
          <defaultValues></defaultValues>
          <forceValues>
            <string>srcBean.getDatasetFirstValueById("uid")</string>
          </forceValues>
          <createValues></createValues>
        </dataset>
        <dataset>
          <name>unixHomeDirectory</name>
          <policy>FORCE</policy>
          <defaultValues></defaultValues>
          <forceValues>
            <string>srcBean.getDatasetFirstValueById("homeDirectory")</string>
          </forceValues>
          <createValues></createValues>
        </dataset>
        <dataset>
          <name>homeDirectory</name>
          <policy>FORCE</policy>
          <defaultValues></defaultValues>
          <forceValues>
            <string>srcBean.getDatasetFirstValueById("sambaHomePath")</string>
          </forceValues>
          <createValues></createValues>
        </dataset>
        <dataset>
          <name>homeDrive</name>
          <policy>FORCE</policy>
          <defaultValues></defaultValues>
          <forceValues>
            <string>srcBean.getDatasetFirstValueById("sambaHomeDrive")</string>
          </forceValues>
          <createValues></createValues>
        </dataset>
        <!--<dataset>
          <name>lastLogon</name>
          <policy>FORCE</policy>
          <defaultValues></defaultValues>
          <forceValues>
            <string>srcBean.getDatasetFirstValueById("sambaLogonTime")</string>
          </forceValues>
          <createValues></createValues>
        </dataset>-->
        <!--<dataset>
          <name>lastLogoff</name>
          <policy>FORCE</policy>
          <defaultValues></defaultValues>
          <forceValues>
            <string>srcBean.getDatasetFirstValueById("sambaLogoffTime")</string>
          </forceValues>
          <createValues></createValues>
        </dataset>-->
        <!--<dataset>
          <name>profilePath</name>
          <policy>FORCE</policy>
          <defaultValues></defaultValues>
          <forceValues>
            <string>srcBean.getDatasetFirstValueById("sambaProfilePath")</string>
          </forceValues>
          <createValues></createValues>
        </dataset>-->
        <dataset>
          <name>ou</name>
          <policy>FORCE</policy>
          <defaultValues></defaultValues>
          <forceValues>
              <string>"ENTPersonLogin;"+srcBean.getDatasetFirstValueById("ENTPersonLogin")</string>
              <string>"ENTPersonJointure;"+srcBean.getDatasetFirstValueById("ENTPersonJointure")</string>
              <string>"ENTPersonProfils;"+srcBean.getDatasetFirstValueById("ENTPersonProfils")</string>
              <string>"ENTPersonNomPatro;"+srcBean.getDatasetFirstValueById("ENTPersonNomPatro")</string>
              <string>"ENTPersonSexe;"+srcBean.getDatasetFirstValueById("ENTPersonSexe")</string>
              <string>"ENTPersonDateNaissance;"+srcBean.getDatasetFirstValueById("ENTPersonDateNaissance")</string>
              <string>"codecivilite;"+srcBean.getDatasetFirstValueById("codeCivilite")</string>
              <string>"dateNaissance;"+srcBean.getDatasetFirstValueById("dateNaissance")</string>
              <string>"intid;"+srcBean.getDatasetFirstValueById("intid")</string>
              <string>"typeadmin;"+srcBean.getDatasetFirstValueById("typeadmin")</string>
              <string>"Divcod;"+srcBean.getDatasetFirstValueById("Divcod")</string>
              <string>"Ine;"+srcBean.getDatasetFirstValueById("Ine")</string>
          </forceValues>
          <createValues></createValues>
          <delimiter>$</delimiter>
        </dataset>
        <dataset>
          <name>userAccountControl</name>
          <policy>FORCE</policy>
          <defaultValues></defaultValues>
          <forceValues>
            <string>"544"</string>
          </forceValues>
          <createValues></createValues>
        </dataset>
      </propertiesBasedSyncOptions>
    </task>
    <task>
      <name>groups</name>
      <bean>org.lsc.beans.SimpleBean</bean>

      <asyncLdapSourceService>
        <name>openldap-src-service-groups</name>
        <connection reference="openldap-src-conn" />
        <baseDn>ou=education,o=gouv,c=fr</baseDn>
        <pivotAttributes>
          <string>cn</string>
        </pivotAttributes>
        <fetchedAttributes>
          <string>cn</string>
          <string>memberUid</string>
          <string>description</string>
          <string>displayName</string>
          <string>mail</string>
          <string>gidNumber</string>
          <string>niveau</string>
          <string>type</string>
        </fetchedAttributes>
        <getAllFilter>(objectClass=posixGroup)</getAllFilter>
        <getOneFilter>(&amp;(objectClass=posixGroup)(cn={cn}))</getOneFilter>
        <cleanFilter>(&amp;(objectClass=posixGroup)(cn={sAMAccountName}))</cleanFilter>
        <serverType>OpenLDAP</serverType>
      </asyncLdapSourceService>
      <ldapDestinationService>
        <name>ldap-dst-service-groups</name>
        <connection reference="ldap-dst-conn" />
        <baseDn>CN=Users,DC=domseth,DC=ac-test,DC=fr</baseDn>
        <pivotAttributes>
          <string>sAMAccountName</string>
        </pivotAttributes>
        <fetchedAttributes>
          <string>sAMAccountName</string>
          <string>objectClass</string>
          <string>cn</string>
          <string>member</string>
          <string>description</string>
          <string>displayName</string>
          <string>mail</string>
          <string>extensionName</string>
        </fetchedAttributes>
        <getAllFilter>(&amp;(objectClass=group)(!(isCriticalSystemObject=TRUE))(!(cn=DnsAdmins))(!(cn=DnsUpdateProxy)))</getAllFilter>
        <getOneFilter>(&amp;(objectClass=group)(!(isCriticalSystemObject=TRUE))(!(cn=DnsAdmins))(!(cn=DnsUpdateProxy))(sAMAccountName={cn}))</getOneFilter>
      </ldapDestinationService>
      <propertiesBasedSyncOptions>
        <mainIdentifier>"CN=" + srcBean.getDatasetFirstValueById("cn") + ",CN=Users,DC=domseth,DC=ac-test,DC=fr"</mainIdentifier>
        <defaultDelimiter>;</defaultDelimiter>
        <defaultPolicy>FORCE</defaultPolicy>
        <conditions>
                <create>true</create>
                <update>true</update>
                <delete>true</delete>
                <changeId>false</changeId>
        </conditions>
        <dataset>
          <name>objectClass</name>
          <policy>KEEP</policy>
          <defaultValues></defaultValues>
          <forceValues></forceValues>
          <createValues>
            <string>"top"</string>
            <string>"group"</string>
          </createValues>
        </dataset>
        <dataset>
          <name>sAMAccountName</name>
          <policy>FORCE</policy>
          <defaultValues></defaultValues>
          <forceValues>
            <string>srcBean.getDatasetFirstValueById("cn")</string>
          </forceValues>
          <createValues></createValues>
        </dataset>
        <dataset>
          <name>member</name>
          <policy>FORCE</policy>
          <defaultValues></defaultValues>
          <forceValues>
            <string>
              <![CDATA[
              var mymembers = srcBean.getDatasetValuesById("memberUid").toArray();
              var mydns = java.lang.reflect.Array.newInstance(java.lang.String.class, mymembers.length);
              for ( var i=0; i<mymembers.length; i++  ) {
                mydns[i] = "CN=" + mymembers[i] + ",CN=Users,DC=domseth,DC=ac-test,DC=fr";
              }
              mydns
              ]]>
            </string>
          </forceValues>
          <createValues></createValues>
          <delimiter>;</delimiter>
        </dataset>
        <dataset>
          <name>extensionName</name>
          <policy>FORCE</policy>
          <defaultValues></defaultValues>
          <forceValues>
              <string>"niveau;"+srcBean.getDatasetFirstValueById("niveau")</string>
              <string>"type;"+srcBean.getDatasetFirstValueById("type")</string>
          </forceValues>
          <createValues></createValues>
          <delimiter>$</delimiter>
        </dataset>
      </propertiesBasedSyncOptions>
    </task>
  </tasks>
</lsc>
